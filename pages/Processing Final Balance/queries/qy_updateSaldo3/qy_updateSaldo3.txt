UPDATE users u
LEFT JOIN (
	SELECT 
	ts.username,
	COALESCE(SUM(ts.amount), 0) - COALESCE(wd.total_withdraw, 0) AS balance_result
	FROM transactions_success ts
	LEFT JOIN (
		SELECT username, SUM(amount) AS total_withdraw
		FROM transactions_wd
		WHERE status = 'Success'
		GROUP BY username
	) wd ON ts.username = wd.username
	GROUP BY ts.username

	UNION

	SELECT 
	wd.username,
	0 - COALESCE(wd.total_withdraw, 0) AS balance_result
	FROM (
		SELECT username, SUM(amount) AS total_withdraw
		FROM transactions_wd
		WHERE status = 'Success'
		GROUP BY username
	) wd
	WHERE wd.username NOT IN (
		SELECT DISTINCT username FROM transactions_success
	)
) result ON u.username = result.username
SET u.balance = COALESCE(result.balance_result, 0);
